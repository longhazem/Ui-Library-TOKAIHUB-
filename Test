local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local Library = {}

function Library:CreateWindow()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "TOKAI_RGB_Library"
    screenGui.Parent = (gethui and gethui()) or game.CoreGui
    screenGui.ResetOnSpawn = false

    local mainSize = UDim2.new(0, 520, 0, 320)

    -- MAIN FRAME
    local main = Instance.new("Frame")
    main.Name = "MainFrame"
    main.Size = UDim2.new(0, 0, 0, 0) -- Khởi tạo từ 0 để phóng to
    main.Position = UDim2.new(0.5, 0, 0.5, 0)
    main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    main.AnchorPoint = Vector2.new(0.5, 0.5)
    main.ClipsDescendants = true
    main.Active = true
    main.Parent = screenGui
    
    Instance.new("UICorner", main).CornerRadius = UDim.new(0, 12)
    
    -- VIỀN LED CHO MAIN
    local mainStroke = Instance.new("UIStroke", main)
    mainStroke.Thickness = 2
    mainStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

    -- SIDEBAR
    local sidebar = Instance.new("Frame")
    sidebar.Size = UDim2.new(0, 150, 1, 0)
    sidebar.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
    sidebar.BorderSizePixel = 0
    sidebar.Parent = main
    Instance.new("UICorner", sidebar).CornerRadius = UDim.new(0, 12)

    -- LOGO DECAL CỦA BẠN
    local logo = Instance.new("ImageLabel", sidebar)
    logo.Size = UDim2.new(0, 45, 0, 45)
    logo.Position = UDim2.new(0, 12, 0, 12)
    logo.BackgroundTransparency = 1
    logo.Image = "rbxassetid://73801656700802" -- ID bạn cung cấp
    Instance.new("UICorner", logo).CornerRadius = UDim.new(1, 0)
    
    local logoStroke = Instance.new("UIStroke", logo)
    logoStroke.Thickness = 2

    -- TÊN LIBRARY: TOKAI
    local title = Instance.new("TextLabel", sidebar)
    title.Size = UDim2.new(1, -65, 0, 45)
    title.Position = UDim2.new(0, 65, 0, 12)
    title.BackgroundTransparency = 1
    title.Text = "TOKAI"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 20
    title.TextXAlignment = Enum.TextXAlignment.Left

    -- NÚT ĐÓNG (X)
    local closeBtn = Instance.new("TextButton", main)
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -35, 0, 5)
    closeBtn.BackgroundTransparency = 1
    closeBtn.Text = "×"
    closeBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
    closeBtn.TextSize = 25
    closeBtn.MouseButton1Click:Connect(function()
        main:TweenSize(UDim2.new(0, 0, 0, 0), "In", "Back", 0.4, true)
    end)

    -- HỆ THỐNG LED RGB
    coroutine.wrap(function()
        local hue = 0
        while true do
            hue = hue + 1/300 
            if hue > 1 then hue = 0 end
            local color = Color3.fromHSV(hue, 0.8, 1)
            mainStroke.Color = color
            logoStroke.Color = color
            RunService.RenderStepped:Wait()
        end
    end)()

    -- LOGIC KÉO THẢ (FIXED)
    local dragging, dragStart, startPos
    main.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true; dragStart = input.Position; startPos = main.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    main.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)

    -- CONTAINER CHO TABS & PAGES
    local pages = Instance.new("Frame", main)
    pages.Size = UDim2.new(1, -170, 1, -60)
    pages.Position = UDim2.new(0, 160, 0, 50)
    pages.BackgroundTransparency = 1

    local tabList = Instance.new("ScrollingFrame", sidebar)
    tabList.Size = UDim2.new(1, 0, 1, -70)
    tabList.Position = UDim2.new(0, 0, 0, 65)
    tabList.BackgroundTransparency = 1
    tabList.ScrollBarThickness = 0
    Instance.new("UIListLayout", tabList).HorizontalAlignment = Enum.HorizontalAlignment.Center

    local first = true
    function Library:CreateTab(name)
        local page = Instance.new("ScrollingFrame", pages)
        page.Size = UDim2.new(1, 0, 1, 0)
        page.BackgroundTransparency = 1
        page.Visible = false
        page.ScrollBarThickness = 0
        Instance.new("UIListLayout", page).Padding = UDim.new(0, 8)

        local tabBtn = Instance.new("TextButton", tabList)
        tabBtn.Size = UDim2.new(0, 130, 0, 35)
        tabBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
        tabBtn.Text = name
        tabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
        tabBtn.Font = Enum.Font.GothamSemibold
        Instance.new("UICorner", tabBtn)

        tabBtn.MouseButton1Click:Connect(function()
            for _, p in pairs(pages:GetChildren()) do p.Visible = false end
            for _, t in pairs(tabList:GetChildren()) do if t:IsA("TextButton") then t.TextColor3 = Color3.fromRGB(150, 150, 150) end end
            page.Visible = true
            tabBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        end)

        if first then page.Visible = true; tabBtn.TextColor3 = Color3.fromRGB(255, 255, 255); first = false end

        local elements = {}
        function elements:AddButton(text, callback)
            local btn = Instance.new("TextButton", page)
            btn.Size = UDim2.new(1, -10, 0, 38)
            btn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
            btn.Text = "  " .. text
            btn.TextColor3 = Color3.fromRGB(255, 255, 255)
            btn.Font = Enum.Font.Gotham
            btn.TextXAlignment = Enum.TextXAlignment.Left
            Instance.new("UICorner", btn)
            
            btn.MouseButton1Click:Connect(callback)
            
            -- Hiệu ứng click
            btn.MouseButton1Down:Connect(function()
                btn:TweenSize(UDim2.new(1, -20, 0, 34), "Out", "Quad", 0.1, true)
            end)
            btn.MouseButton1Up:Connect(function()
                btn:TweenSize(UDim2.new(1, -10, 0, 38), "Out", "Quad", 0.1, true)
            end)
        end
        return elements
    end

    -- Mở UI
    main:TweenSize(mainSize, "Out", "Back", 0.5, true)
    return Library
end

-- --- SỬ DỤNG ---
local win = Library:CreateWindow()
local t1 = win:CreateTab("Main")
t1:AddButton("Welcome to TOKAI!", function() print("Running...") end)
local t2 = win:CreateTab("Settings")
