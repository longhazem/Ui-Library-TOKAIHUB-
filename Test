local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local Library = {}

function Library:CreateWindow()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "TOKAIHUB"
    screenGui.Parent = (gethui and gethui()) or game.CoreGui
    screenGui.ResetOnSpawn = false

    local mainSize = UDim2.new(0, 520, 0, 320)
    local logoID = "rbxassetid://136094224630213"

    -- NÚT MỞ UI (GỌN GÀNG Ở GÓC)
    local openBtn = Instance.new("ImageButton", screenGui)
    openBtn.Size = UDim2.new(0, 50, 0, 50)
    openBtn.Position = UDim2.new(0, 10, 0.5, -25)
    openBtn.Visible = false -- Mặc định ẩn
    openBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    openBtn.Image = logoID
    openBtn.BorderSizePixel = 0
    Instance.new("UICorner", openBtn).CornerRadius = UDim.new(1, 0)
    local openStroke = Instance.new("UIStroke", openBtn)
    openStroke.Thickness = 2

    -- MAIN FRAME
    local main = Instance.new("Frame")
    main.Name = "MainFrame"
    main.Size = mainSize
    main.Position = UDim2.new(0.5, 0, 0.5, 0)
    main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    main.AnchorPoint = Vector2.new(0.5, 0.5)
    main.ClipsDescendants = true
    main.Active = true
    main.Visible = true -- Mặc định hiện
    main.Parent = screenGui
    
    Instance.new("UICorner", main).CornerRadius = UDim.new(0, 12)
    local mainStroke = Instance.new("UIStroke", main)
    mainStroke.Thickness = 2

    -- HIỆU ỨNG BẤM RA HOA ANH ĐÀO & ĐỐM TÍM
    local function SpawnSakura(x, y)
        local colors = {Color3.fromRGB(255, 192, 210), Color3.fromRGB(210, 180, 255), Color3.fromRGB(255, 255, 255)}
        for i = 1, 6 do
            local p = Instance.new("Frame", main)
            p.Size = UDim2.new(0, math.random(5, 8), 0, math.random(5, 8))
            p.Position = UDim2.new(0, x, 0, y)
            p.BackgroundColor3 = colors[math.random(1, #colors)]
            p.BorderSizePixel = 0
            p.ZIndex = 15
            Instance.new("UICorner", p).CornerRadius = UDim.new(1, 0)
            
            local t = TweenService:Create(p, TweenInfo.new(0.8, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {
                Position = UDim2.new(0, x + math.random(-60, 60), 0, y + math.random(-60, 60)),
                BackgroundTransparency = 1,
                Rotation = math.random(-180, 180),
                Size = UDim2.new(0, 0, 0, 0)
            })
            t:Play()
            t.Completed:Connect(function() p:Destroy() end)
        end
    end

    -- NÚT ĐÓNG (FIX TRIỆT ĐỂ LỖI KHÔNG MẤT UI)
    local closeBtn = Instance.new("TextButton", main)
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -35, 0, 5)
    closeBtn.BackgroundTransparency = 1
    closeBtn.Text = "×"
    closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeBtn.TextSize = 25
    closeBtn.ZIndex = 20

    closeBtn.MouseButton1Click:Connect(function()
        -- Animation thu nhỏ và ẩn hoàn toàn
        local tween = TweenService:Create(main, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
            Size = UDim2.new(0, 0, 0, 0),
            BackgroundTransparency = 1
        })
        tween:Play()
        tween.Completed:Connect(function()
            main.Visible = false -- Biến mất hoàn toàn khỏi màn hình
            openBtn.Visible = true -- Hiện nút mở lại
        end)
    end)

    openBtn.MouseButton1Click:Connect(function()
        openBtn.Visible = false
        main.Visible = true
        main:TweenSize(mainSize, "Out", "Back", 0.5, true)
        TweenService:Create(main, TweenInfo.new(0.5), {BackgroundTransparency = 0}):Play()
    end)

    -- LED RGB
    coroutine.wrap(function()
        local h = 0
        while true do
            h = h + 1/350
            local col = Color3.fromHSV(h%1, 0.6, 1)
            mainStroke.Color = col
            openStroke.Color = col
            RunService.RenderStepped:Wait()
        end
    end)()

    -- KÉO THẢ MƯỢT MÀ
    local dragging, dragInput, dragStart, startPos
    main.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            local m = UserInputService:GetMouseLocation()
            SpawnSakura(m.X - main.AbsolutePosition.X, m.Y - main.AbsolutePosition.Y - 36)
            dragging = true; dragStart = input.Position; startPos = main.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
    end)
    RunService.RenderStepped:Connect(function()
        if dragging and dragInput then
            local delta = dragInput.Position - dragStart
            main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)

    -- CÁC PHẦN SIDEBAR VÀ PAGE (GIỮ NGUYÊN)
    local sidebar = Instance.new("Frame", main)
    sidebar.Size = UDim2.new(0, 150, 1, 0)
    sidebar.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
    sidebar.BorderSizePixel = 0
    Instance.new("UICorner", sidebar).CornerRadius = UDim.new(0, 12)

    local logo = Instance.new("ImageLabel", sidebar)
    logo.Size = UDim2.new(0, 42, 0, 42); logo.Position = UDim2.new(0, 12, 0, 12)
    logo.BackgroundTransparency = 1; logo.Image = logoID
    Instance.new("UICorner", logo).CornerRadius = UDim.new(1, 0)

    local title = Instance.new("TextLabel", sidebar)
    title.Size = UDim2.new(1, -65, 0, 42); title.Position = UDim2.new(0, 60, 0, 12)
    title.BackgroundTransparency = 1; title.Text = "TOKAI"; title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold; title.TextSize = 20; title.TextXAlignment = Enum.TextXAlignment.Left

    local pages = Instance.new("Frame", main)
    pages.Size = UDim2.new(1, -170, 1, -65); pages.Position = UDim2.new(0, 160, 0, 55); pages.BackgroundTransparency = 1

    local tabList = Instance.new("ScrollingFrame", sidebar)
    tabList.Size = UDim2.new(1, 0, 1, -75); tabList.Position = UDim2.new(0, 0, 0, 70)
    tabList.BackgroundTransparency = 1; tabList.ScrollBarThickness = 0
    Instance.new("UIListLayout", tabList).HorizontalAlignment = Enum.HorizontalAlignment.Center

    local first = true
    function Library:CreateTab(name)
        local page = Instance.new("ScrollingFrame", pages)
        page.Size = UDim2.new(1, 0, 1, 0); page.BackgroundTransparency = 1; page.Visible = false; page.ScrollBarThickness = 0
        Instance.new("UIListLayout", page).Padding = UDim.new(0, 8)

        local tabBtn = Instance.new("TextButton", tabList)
        tabBtn.Size = UDim2.new(0, 130, 0, 35); tabBtn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
        tabBtn.Text = name; tabBtn.TextColor3 = Color3.fromRGB(150, 150, 150); tabBtn.Font = Enum.Font.GothamSemibold
        Instance.new("UICorner", tabBtn)

        tabBtn.MouseButton1Click:Connect(function()
            for _, v in pairs(pages:GetChildren()) do v.Visible = false end
            for _, v in pairs(tabList:GetChildren()) do if v:IsA("TextButton") then v.TextColor3 = Color3.fromRGB(150, 150, 150) end end
            page.Visible = true; tabBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        end)
        if first then page.Visible = true; tabBtn.TextColor3 = Color3.fromRGB(255, 255, 255); first = false end

        local elements = {}
        function elements:AddButton(text, callback)
            local btn = Instance.new("TextButton", page)
            btn.Size = UDim2.new(1, -10, 0, 38); btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
            btn.Text = "  " .. text; btn.TextColor3 = Color3.fromRGB(255, 255, 255)
            btn.Font = Enum.Font.Gotham; btn.TextXAlignment = Enum.TextXAlignment.Left
            Instance.new("UICorner", btn)
            btn.MouseButton1Click:Connect(callback)
        end
        return elements
    end

    return Library
end

-- --- TEST ---
local win = Library:CreateWindow()
local t1 = win:CreateTab("Main")
t1:AddButton("Click Test Effect", function() end)
